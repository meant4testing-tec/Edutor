<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medicine Reminder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {
                '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a', '950': '#172554',
              },
              secondary: {
                '50': '#f0fdfa', '100': '#ccfbf1', '200': '#99f6e4', '300': '#5eead4', '400': '#2dd4bf', '500': '#14b8a6', '600': '#0d9488', '700': '#0f766e', '800': '#115e59', '900': '#134e4a', '950': '#042f2e',
              }
            }
          }
        }
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
    <script>
      if ('serviceWorker' in navigator) {
        const swCode = `
          const DB_NAME = 'MedicineReminderDB';
          const DB_VERSION = 1;
          const SCHEDULES_STORE = 'schedules';
          const MEDICINES_STORE = 'medicines';

          const DoseStatus = { PENDING: 'pending' };
          let dbInstance = null;

          const getDB = () => {
            return new Promise((resolve, reject) => {
              if (dbInstance) {
                resolve(dbInstance);
                return;
              }
              const request = indexedDB.open(DB_NAME, DB_VERSION);
              request.onerror = () => reject(request.error);
              request.onsuccess = () => {
                dbInstance = request.result;
                resolve(dbInstance);
              };
              // No onupgradeneeded here, as the main app handles DB creation.
            });
          };

          let activeProfileId = null;
          let notificationInterval = null;

          self.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'SET_PROFILE') {
              activeProfileId = event.data.profileId;
              if (notificationInterval) clearInterval(notificationInterval);
              if (activeProfileId) {
                notificationInterval = setInterval(checkForNotifications, 60000);
                checkForNotifications();
              }
            }
          });

          async function checkForNotifications() {
            if (!activeProfileId || !self.registration) return;

            try {
              const db = await getDB();
              const now = new Date();
              const twoMinutesAgo = new Date(now.getTime() - 2 * 60 * 1000);

              const transaction = db.transaction([SCHEDULES_STORE, MEDICINES_STORE], 'readwrite');
              const schedulesStore = transaction.objectStore(SCHEDULES_STORE);
              const timeIndex = schedulesStore.index('scheduledTime');
              const range = IDBKeyRange.bound(twoMinutesAgo.toISOString(), now.toISOString());
              
              const schedulesRequest = timeIndex.getAll(range);

              schedulesRequest.onsuccess = () => {
                const potentialSchedules = schedulesRequest.result;
                const dueSchedules = potentialSchedules.filter(s =>
                  s.profileId === activeProfileId &&
                  s.status === DoseStatus.PENDING &&
                  !s.notificationShown
                );

                if (dueSchedules.length > 0) {
                  const dueSchedule = dueSchedules[0];
                  const medicinesStore = transaction.objectStore(MEDICINES_STORE);
                  const medicineRequest = medicinesStore.get(dueSchedule.medicineId);

                  medicineRequest.onsuccess = () => {
                    const medicine = medicineRequest.result;
                    if (medicine) {
                      const title = \`Time for \${medicine.name}!\`;
                      const body = \`It's time for \${medicine.name} (\${medicine.dose}).\`;
                      
                      self.registration.showNotification(title, { body, tag: dueSchedule.id, icon: '/vite.svg' });

                      dueSchedule.notificationShown = true;
                      schedulesStore.put(dueSchedule);
                    }
                  };
                }
              };
            } catch (error) {
              console.error('SW: Error checking notifications:', error);
            }
          }

          self.addEventListener('notificationclick', (event) => {
            event.notification.close();
            event.waitUntil(
              clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
                if (clientList.length > 0) {
                  let client = clientList[0];
                  for (let i = 0; i < clientList.length; i++) {
                    if (clientList[i].focused) {
                      client = clientList[i];
                    }
                  }
                  return client.focus();
                }
                return clients.openWindow('/');
              })
            );
          });
        `;
        const swBlob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);

        window.addEventListener('load', () => {
          navigator.serviceWorker.register(swUrl)
            .then(registration => console.log('Service Worker registered:', registration))
            .catch(err => console.error('Service Worker registration failed:', err));
        });
      }
    </script>
  </body>
</html>